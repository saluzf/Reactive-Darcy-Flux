using Test
include("../src/IsothermalSalineAquifier_3D_multixpu.jl")

@testset "3D" begin
    # unit tests for boundary function
    A = rand(5,5,5)
    A = Data.Array(A)
    @parallel (1:size(A, 2), 1:size(A, 3)) bc_x!(A)
    @parallel (1:size(A, 1), 1:size(A, 3)) bc_y!(A)
    @parallel (1:size(A, 1), 1:size(A, 2)) bc_z!(A)
    @test A[1  , :, :]      == A[2    ,  :, :]
    @test A[end, :, :]      == A[end-1, :, :]
    @test A[:  , 1, :]      == A[:    ,  2, :]
    @test A[end, :, :]      == A[end-1, :, :]
    # ref test
    T, C = IsothermalSalineAquifier3D(;nz=3,nt=3,do_viz=false)
    @test isapprox(T, [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0;;; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0;;; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0])
    @test isapprox(C, [100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0;;; 49.46019017530737 49.46019017530737 49.46019017530737; 49.46019017530737 49.46019017530737 49.46019017530737; 50.57933591729566 50.57933591729566 50.57933591729566; 77.22373502043955 77.22373502043955 77.22373502043955; 50.58341603559192 50.58341603559192 50.58341603559192; 49.459265966036845 49.459265966036845 49.459265966036845; 49.459265966036845 49.459265966036845 49.459265966036845;;; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0])
end;