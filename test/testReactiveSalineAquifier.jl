using Test
include("../src/ReactiveSalineAquifier_3D_multixpu.jl")

@testset "3D" begin
    # unit tests for boundary function
    A = rand(5,5,5)
    A = Data.Array(A)
    @parallel (1:size(A, 2), 1:size(A, 3)) bc_x!(A)
    @parallel (1:size(A, 1), 1:size(A, 3)) bc_y!(A)
    @parallel (1:size(A, 1), 1:size(A, 2)) bc_z!(A)
    @test A[1  , :, :]      == A[2    ,  :, :]
    @test A[end, :, :]      == A[end-1, :, :]
    @test A[:  , 1, :]      == A[:    ,  2, :]
    @test A[end, :, :]      == A[end-1, :, :]
    # ref test
    T, C = ReactiveSalineAquifier3D(;nz=3,nt=3,do_viz=false)
    print(T)
    @test isapprox(T, [100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0; 100.0 100.0 100.0;;; -8.905006705268663 -8.905006705268663 -8.905006705268663; -8.905006705268663 -8.905006705268663 -8.905006705268663; -20.408218059548577 -20.408218059548577 -20.408218059548577; 143.01822335634796 143.01822335634796 143.01822335634796; -20.408218059548577 -20.408218059548577 -20.408218059548577; -8.905006705268663 -8.905006705268663 -8.905006705268663; -8.905006705268663 -8.905006705268663 -8.905006705268663;;; -100.0 -100.0 -100.0; -100.0 -100.0 -100.0; -100.0 -100.0 -100.0; -100.0 -100.0 -100.0; -100.0 -100.0 -100.0; -100.0 -100.0 -100.0; -100.0 -100.0 -100.0])
    @test isapprox(C, [8.951753938992822e-22 8.951753938992822e-22 8.951753938992822e-22; 8.951753938992822e-22 8.951753938992822e-22 8.951753938992822e-22; 8.94390693932558e-22 8.94390693932558e-22 8.94390693932558e-22; 3.3575476333487613e-21 3.3575476333487613e-21 3.3575476333487613e-21; 8.94390693932558e-22 8.94390693932558e-22 8.94390693932558e-22; 8.951753938992822e-22 8.951753938992822e-22 8.951753938992822e-22; 8.951753938992822e-22 8.951753938992822e-22 8.951753938992822e-22;;; 3.219062490207432e-22 3.219062490207432e-22 3.219062490207432e-22; 3.219062490207432e-22 3.219062490207432e-22 3.219062490207432e-22; 2.981312464330695e-22 2.981312464330695e-22 2.981312464330695e-22; 3.903821289774828e-21 3.903821289774828e-21 3.903821289774828e-21; 2.981312464330695e-22 2.981312464330695e-22 2.981312464330695e-22; 3.219062490207432e-22 3.219062490207432e-22 3.219062490207432e-22; 3.219062490207432e-22 3.219062490207432e-22 3.219062490207432e-22;;; 2.2117677011111455e-22 2.2117677011111455e-22 2.2117677011111455e-22; 2.2117677011111455e-22 2.2117677011111455e-22 2.2117677011111455e-22; 2.2039207014439034e-22 2.2039207014439034e-22 2.2039207014439034e-22; 2.6835490095605933e-21 2.6835490095605933e-21 2.6835490095605933e-21; 2.2039207014439034e-22 2.2039207014439034e-22 2.2039207014439034e-22; 2.2117677011111455e-22 2.2117677011111455e-22 2.2117677011111455e-22; 2.2117677011111455e-22 2.2117677011111455e-22 2.2117677011111455e-22])

end;